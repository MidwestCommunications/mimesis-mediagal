{% extends "site_base.html" %}

{% load i18n %}
{% load bootstrap_tags %}

{% block extra_head %}
    <script src="{{ STATIC_URL }}js/swfupload.js"></script>
    <script src="{{ STATIC_URL}}js/swfupload.cookies.js"></script>
    <script>
        var swfupload;
        $(function () {
            swfupload = new SWFUpload({
                debug: false,
                upload_url: "{% url gallery_resource_upload %}",
                flash_url: "{{ STATIC_URL }}swf/swfupload.swf",
                post_params: { "csrfmiddlewaretoken": "{{ csrf_token }}" },

                button_placeholder_id: "upload_btn",
                button_width: "97",
                button_height: "28",
                button_cursor: SWFUpload.CURSOR.HAND,
                button_window_mode: SWFUpload.WINDOW_MODE.TRANSPARENT,
                
                // Handler functions
                upload_complete_handler: uploadDone,
                file_dialog_complete_handler: dialogDone,
            });
        });
        
        function doSubmit(e) {
            e = e || window.event;
            
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.cancelBubble = true;
            
            try {
                swfupload.startUpload();
            } catch (ex) {
                alert("Can't upload file.");
            }
            
            return false;
        };
        
        function uploadDone() {
            var uploads = swfupload.getStats().successful_uploads,
                i = 0;
            
            for (i; i++; i < uploads) {
                console.log(swfupload.getFiles(i));
            };
        };
        
        /* 
        Parameters: num_select - number of files selected in the dialog
                    num_queued - number of files successfully added to the queue
                    total_queued - total number of files in the queue
        */
        function dialogDone(num_selected, num_queued, total_queued) {
            var file_list = [],
                list_str = "",
                i;
            
            // Note that we're basically overwriting the entire list if the user
            // accesses the dialog more than once, so accessing via the total_queued
            // nunmber won't result in dupes.
            for (i=0; i < total_queued; i++) {
                var f = swfupload.getFile(i);
                console.log(i);
                file_list.push(f);
                list_str += '<li class="file_list_entry" id="file_' + i + '">' + f.name + '</li>'
            };
            
            console.log(file_list);
            
            $("#file_list").html(list_str);
        };
    </script>
    <!-- Hover the invisible button over the "real" button. -->
    <style type="text/css">
    .swfupload {position: absolute; z-index: 1;}
    </style>
{% endblock %}


{% block body %}

    <div id="file_viewer">
        <ul id="file_list">
            <li>No files selected yet.</li>
        </ul>
    </div>

    <div class="actions">
        <span id="upload_btn"></span>
        <button id="btn_upload" class="btn primary">{% trans "Select Files" %}</button>

        <button type="" class="btn primary" id="gallery_create">{% trans "Create Gallery" %}</button>
    </div>

{% endblock body %}

{% block extra_body %}
    <script>
        $("#gallery_create").click(function () {
            doSubmit();
        });
    </script>
{% endblock extra_body %}